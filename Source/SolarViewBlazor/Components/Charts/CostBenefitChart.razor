<div class="d-flex">
  <button class="ml-auto" @onclick="DeleteChart">Remove</button>
</div>
<div>
  <SfChart Title=@($"Period: {ChartData.StartDate:yyyy-MM-dd} to {ChartData.EndDate:yyyy-MM-dd}")>
    <ChartArea>
      <ChartAreaBorder Width="1" />
    </ChartArea>

    <ChartPrimaryXAxis ValueType="Syncfusion.Blazor.Charts.ValueType.Category" LabelFormat="{value}"
                       IntervalType="IntervalType.Auto" EdgeLabelPlacement="EdgeLabelPlacement.Shift"/>

    <ChartPrimaryYAxis Minimum=@MinCost Maximum=@MaxCost Interval="0.2" LabelFormat="c" />

    <ChartTooltipSettings Enable="true" />

    <ChartSeriesCollection>
      <ChartSeries DataSource=@_costData Type="ChartSeriesType.Line" Width="2" Fill="#006400"
                   XName=@nameof(PowerCost.Time) YName=@nameof(PowerCost.AdjustedCost) />

      <ChartSeries DataSource=@_costData Type="ChartSeriesType.Line" Width="2" Fill="#640000"
                   XName=@nameof(PowerCost.Time) YName=@nameof(PowerCost.NoSolarCost) />
    </ChartSeriesCollection>
  </SfChart>
</div>

@code {

  [CascadingParameter] public ChartContainer Parent { get; set; }
  [Parameter] public ChartData ChartData { get; set; }

  private class PowerCost
  {
    private double PurchaseCostPerW = 0.3283379d / 1000.0d;
    private double FeedInCostPerW = 0.105d / 1000.0d;

    public string Time { get; }
    public double AdjustedCost { get; }
    public double NoSolarCost { get; }

    public PowerCost(PowerData powerData)
    {
      Time = powerData.Time;
      AdjustedCost = powerData.Purchased * PurchaseCostPerW - powerData.FeedIn * FeedInCostPerW;
      NoSolarCost = (powerData.Purchased + powerData.SelfConsumption) * PurchaseCostPerW;
    }
  }

  private IReadOnlyList<PowerCost> _costData;

  private double MinCost { get; set; }
  private double MaxCost { get; set; }

  // watts fed into the system are worth less than watts purchased
  //private const double FeedInValueFactor = 0.105d / 0.3283379d;
  //public double WithSolar => Purchased - FeedIn * FeedInValueFactor;
  //public double WithoutSolar => Purchased + SelfConsumption;


  protected override void OnParametersSet()
  {
    base.OnParametersSet();

    if (Parent == null)
    {
      throw new InvalidOperationException($"The {nameof(Parent)} parameter must be initialized");
    }

    if (ChartData?.Power == null)
    {
      throw new InvalidOperationException($"The {nameof(ChartData)} parameter must be initialized with power data");
    }

    _costData = ChartData.Power
      .Select(item => new PowerCost(item))
      .ToList();

    CalculateChartLimits();
  }

  private void CalculateChartLimits()
  {
    var minCost = _costData.Min(item => item.AdjustedCost);
    var maxCost = _costData.Max(item => item.NoSolarCost);

    if (minCost > 0.0d)
    {
      MinCost = Math.Floor(minCost / 0.2d) * 0.2d;              // intervals of 0.2 on chart
    }
    else
    {
      MinCost = -(1 + Math.Floor(-minCost / 0.2d)) * 0.2d;      // intervals of 0.2 on chart
    }

    MaxCost = (1 + Math.Floor(maxCost / 0.2d)) * 0.2d;          // intervals of 0.2 on chart
  }

  private async Task DeleteChart()
  {
    await Parent.DeleteChart(ChartData.Id);
  }
}
