@page "/settings"

@attribute [Authorize]
@implements IDisposable

<h1>Settings</h1>

<SiteView>
  <Loading>
    <LoadingView />
  </Loading>
  <SiteAvailable>
    <div class="mb-4">
      <SfAccordion ExpandMode="ExpandMode.Single">
        <AccordionItems>
          <AccordionItem Expanded="true">
            <HeaderTemplate>Site Info</HeaderTemplate>
            <ContentTemplate>
              <div class="content border border-primary settings-card">
                <SiteInfo Site="@CurrentSite" />
              </div>
            </ContentTemplate>
          </AccordionItem>
          <AccordionItem Expanded="false">
            <HeaderTemplate>User Info</HeaderTemplate>
            <ContentTemplate>
              <div class="content border border-primary settings-card">
                <UserInfo />
              </div>
            </ContentTemplate>
          </AccordionItem>
        </AccordionItems>
      </SfAccordion>

      <button class="btn btn-outline-primary btn-width-medium mt-4 mr-2" @onclick="ClearLocalStorage">Clear Cache</button>
    </div>
  </SiteAvailable>
  <SiteNotAvailable>
    <p class="mt-4 mb-4">You should not have landed here, There's no data to display.</p>
    <a href="">You need to provide a Site Id</a>
  </SiteNotAvailable>
</SiteView>

@code {
  [Inject] private ISiteViewModel SiteViewModel { get; set; }
  [Inject] IEventAggregator EventAggregator { get; set; }
  [Inject] IChartDataCache ChartDataCache { get; set; }
  [Inject] private NavigationManager NavigationManager { get; set; }

  private ISiteInfo CurrentSite => SiteViewModel.CurrentSite;

  public void Dispose()
  {
    EventAggregator.Unsubscribe<SiteChanged>(HandleSiteChanged);
  }

  protected override void OnInitialized()
  {
    base.OnInitialized();

    EventAggregator.Subscribe<SiteChanged>(HandleSiteChanged);
  }

  private void HandleSiteChanged(SiteChanged message)
  {
    StateHasChanged();
  }

  private async Task ClearLocalStorage()
  {
    await ChartDataCache.ClearAsync(SiteViewModel.CurrentSite.SiteId);
    await SiteViewModel.ForgetSiteAsync();

    // go back to the home page so the user can connect to a new site
    NavigationManager.NavigateTo("/");
  }
}